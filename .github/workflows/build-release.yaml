name: Build Release

on:
  release:
    types: [published]

jobs:
  release:
    name: Release Go Binary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0          # ensure tags/history for goreleaser
          fetch-tags: true

      - name: Free disk space (keep toolcache)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false       # IMPORTANT: don't wipe runner tool cache
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: ./go.mod

      - name: Disk report (pre-build)
        run: |
          df -h
          du -hs .git || true
          du -hs ~/go/pkg/mod || true
          du -hs ~/go/build-cache || true

      - name: Codebase security check
        continue-on-error: true
        uses: snyk/actions/golang@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Setup Release Environment
        run: |-
          echo 'MIXPANEL_PROJECT_TOKEN=${{ secrets.MIXPANEL_PROJECT_TOKEN }}' > .release-env
          echo 'LILICO_TOKEN=${{ secrets.LILICO_TOKEN }}' >> .release-env
          echo 'APP_VERSION=$(basename ${GITHUB_REF})' >> .release-env
          echo 'BUILD_TIME=$(date --iso-8601=seconds)' >> .release-env
          echo 'VERSION=${{ github.event.release.tag_name }}' >> .release-env
          echo 'GITHUB_TOKEN=${{ secrets.FLOW_CLI_RELEASE }}' >> .release-env
          mkdir -p "${GITHUB_WORKSPACE}/tmp"
          echo "TMPDIR=/tmp" >> .release-env
          echo "GOTMPDIR=/tmp" >> .release-env

      - name: Build and Release
        run: make release
